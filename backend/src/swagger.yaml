openapi: 3.0.3
info:
  title: UAIFood API
  version: 1.0.0
  description: |
    API do UAIFood (YAML). Segurança JWT via Bearer JWT.
    Também é aceito o cabeçalho `x-access-token` como alternativa (estilo jwt-example).

    ## Autenticação
    Esta API exige autenticação para a maioria dos endpoints. Você pode enviar o token JWT de duas formas:

    1) Header Authorization (preferencial)

    ```bash
    curl -H "Authorization: Bearer <seu_token>" http://localhost:3333/api/users/me
    ```

    2) Header x-access-token (compatibilidade com jwt-example)

    ```bash
    curl -H "x-access-token: <seu_token>" http://localhost:3333/api/users/me
    ```

    Para obter o token, faça login em `/api/auth/login`.
servers:
  - url: http://localhost:3333
    description: Desenvolvimento local
security:
  # Requisitos globais: qualquer endpoint exige autenticação (Bearer ou x-access-token),
  # exceto aqueles que explicitamente definirem `security: []` nas suas operações abaixo.
  - bearerAuth: []
  - xAccessToken: []
tags:
  - name: Health
  - name: Auth
  - name: Menu
  - name: Users
  - name: Orders
  - name: Admin
paths:
  /health:
    get:
      tags: [Health]
      summary: Verifica saúde do servidor
      security: []  # público
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status: { type: string, example: ok }
  /api/auth/register:
    post:
      tags: [Auth]
      summary: Cria usuário cliente
      security: []  # público
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/RegisterRequest' }
            examples:
              exemplo:
                value:
                  name: Maria Silva
                  email: maria@exemplo.com
                  password: senhaForte123
                  phone: +5531999999999
      responses:
        '201': { description: Criado }
        '400': { $ref: '#/components/responses/BadRequest' }
        '422': { $ref: '#/components/responses/UnprocessableEntity' }
        '409': { $ref: '#/components/responses/ConflictEmail' }
  /api/auth/login:
    post:
      tags: [Auth]
      summary: Autentica usuário e retorna JWT
      security: []  # público
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/LoginRequest' }
            examples:
              exemplo:
                value:
                  email: root@uaifood.com
                  password: root
      responses:
        '200':
          description: Autenticado
          content:
            application/json:
              schema: { $ref: '#/components/schemas/LoginResponse' }
              examples:
                sucesso:
                  value:
                    token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                    user:
                      id: uuid-user
                      name: Root
                      email: root@uaifood.com
                      role: ROOT
        '400': { $ref: '#/components/responses/BadRequest' }
        '422': { $ref: '#/components/responses/UnprocessableEntity' }
        '401': { $ref: '#/components/responses/Unauthorized' }
  /api/menu:
    get:
      tags: [Menu]
      summary: Lista categorias e itens ativos
      security: []  # público
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  categories:
                    type: array
                    items: { $ref: '#/components/schemas/CategoryWithItems' }
              examples:
                exemplo:
                  value:
                    categories:
                      - id: cat-bebidas
                        name: Bebidas
                        items:
                          - id: it-coca
                            name: Coca-Cola Lata
                            price: 6.5
                            description: Refrigerante 350ml
                            is_active: true
  /api/menu/items:
    post:
      tags: [Menu]
      summary: Cria item (ADMIN/ROOT)
      security:
        - bearerAuth: []
        - xAccessToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CreateItemRequest' }
            examples:
              exemplo:
                value:
                  name: Suco de Laranja
                  price: 8.0
                  categoryId: cat-bebidas
                  description: Suco natural 300ml
                  image_url: https://cdn.exemplo.com/sucos/laranja.jpg
      responses:
        '201':
          description: Criado
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Item' }
        '422': { $ref: '#/components/responses/UnprocessableEntity' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
  /api/menu/items/{id}:
    patch:
      tags: [Menu]
      summary: Atualiza item (ADMIN/ROOT)
      security:
        - bearerAuth: []
        - xAccessToken: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/UpdateItemRequest' }
            examples:
              exemplo:
                value:
                  price: 7.5
                  description: Suco natural 300ml (sem açúcar)
      responses:
        '200': { description: OK }
        '404': { $ref: '#/components/responses/NotFound' }
        '422': { $ref: '#/components/responses/UnprocessableEntity' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
    delete:
      tags: [Menu]
      summary: Remove item (soft delete) (ADMIN/ROOT)
      security:
        - bearerAuth: []
        - xAccessToken: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        '204': { description: Removido }
        '404': { $ref: '#/components/responses/NotFound' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
  /api/users/me:
    get:
      tags: [Users]
      summary: Dados do usuário autenticado
      security:
        - bearerAuth: []
        - xAccessToken: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/User' }
              examples:
                exemplo:
                  value:
                    id: uuid-user
                    name: Maria Silva
                    email: maria@exemplo.com
                    role: CLIENTE
        '401': { $ref: '#/components/responses/Unauthorized' }
        '404': { $ref: '#/components/responses/NotFound' }
    patch:
      tags: [Users]
      summary: Atualiza dados básicos (confirma senha)
      security:
        - bearerAuth: []
        - xAccessToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/UserUpdate' }
            examples:
              exemplo:
                value:
                  name: Maria S.
                  phone: +5531888888888
                  address: Rua Exemplo, 123
                  zip_code: 30100-000
                  password: senhaForte123
      responses:
        '200': { description: Atualizado }
        '400': { $ref: '#/components/responses/BadRequest' }
        '422': { $ref: '#/components/responses/UnprocessableEntity' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '404': { $ref: '#/components/responses/NotFound' }
  /api/users/me/change-password:
    post:
      tags: [Users]
      summary: Troca a própria senha
      security:
        - bearerAuth: []
        - xAccessToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ChangePasswordRequest' }
            examples:
              exemplo:
                value:
                  currentPassword: senhaAntiga123
                  newPassword: novaSenhaSegura456
                  confirmPassword: novaSenhaSegura456
      responses:
        '204': { description: Senha alterada }
        '400': { $ref: '#/components/responses/BadRequest' }
        '422': { $ref: '#/components/responses/UnprocessableEntity' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '404': { $ref: '#/components/responses/NotFound' }
  /api/users:
    get:
      tags: [Users]
      summary: Lista usuários (ADMIN/ROOT)
      security:
        - bearerAuth: []
        - xAccessToken: []
      parameters:
        - in: query
          name: page
          schema: { type: integer, minimum: 1, example: 1 }
        - in: query
          name: pageSize
          schema: { type: integer, minimum: 1, maximum: 100, example: 20 }
      responses:
        '200': { description: OK }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
  /api/users/{id}/role:
    patch:
      tags: [Users]
      summary: Altera role (ROOT)
      security:
        - bearerAuth: []
        - xAccessToken: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/RoleUpdate' }
            examples:
              exemplo:
                value:
                  role: ADMIN
      responses:
        '200': { description: OK }
        '400': { $ref: '#/components/responses/BadRequest' }
        '404': { $ref: '#/components/responses/NotFound' }
        '422': { $ref: '#/components/responses/UnprocessableEntity' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
  /api/users/{id}/password:
    post:
      tags: [Users]
      summary: Redefine senha de usuário (ADMIN/ROOT)
      security:
        - bearerAuth: []
        - xAccessToken: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/AdminResetPassword' }
            examples:
              exemplo:
                value:
                  password: NovaSenha123!
      responses:
        '200': { description: OK }
        '400': { $ref: '#/components/responses/BadRequest' }
        '404': { $ref: '#/components/responses/NotFound' }
        '422': { $ref: '#/components/responses/UnprocessableEntity' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
  /api/users/{id}:
    delete:
      tags: [Users]
      summary: Desativa usuário (ADMIN/ROOT)
      security:
        - bearerAuth: []
        - xAccessToken: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        '204': { description: Desativado }
        '400': { $ref: '#/components/responses/BadRequest' }
        '404': { $ref: '#/components/responses/NotFound' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
  /api/orders:
    get:
      tags: [Orders]
      summary: Lista pedidos do usuário autenticado
      security:
        - bearerAuth: []
        - xAccessToken: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  orders:
                    type: array
                    items: { $ref: '#/components/schemas/OrderWithItems' }
              examples:
                exemplo:
                  value:
                    orders:
                      - id: ord-123
                        status: PENDENTE
                        table_number: '5'
                        payment_method: PIX
                        total: 33.9
                        created_at: '2025-11-12T12:00:00Z'
                        items:
                          - id: oi-1
                            quantity: 2
                            unit_price: 6.5
                            total_price: 13.0
                            item:
                              id: it-coca
                              name: Coca-Cola Lata
                              price: 6.5
        '401': { $ref: '#/components/responses/Unauthorized' }
    post:
      tags: [Orders]
      summary: Cria pedido (mesa obrigatória)
      security:
        - bearerAuth: []
        - xAccessToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CreateOrderRequest' }
            examples:
              exemplo:
                value:
                  tableNumber: '7'
                  paymentMethod: PIX
                  items:
                    - itemId: it-coca
                      quantity: 2
                    - itemId: it-burguer
                      quantity: 1
      responses:
        '201': { description: Criado }
        '400': { $ref: '#/components/responses/BadRequest' }
        '422': { $ref: '#/components/responses/UnprocessableEntity' }
        '401': { $ref: '#/components/responses/Unauthorized' }
  /api/admin/dashboard:
    get:
      tags: [Admin]
      summary: Métricas rápidas (ADMIN/ROOT)
      security:
        - bearerAuth: []
        - xAccessToken: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  users: { type: integer, example: 42 }
                  items: { type: integer, example: 18 }
                  orders: { type: integer, example: 105 }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
  /api/admin/orders:
    get:
      tags: [Admin]
      summary: Lista pedidos (ADMIN/ROOT)
      security:
        - bearerAuth: []
        - xAccessToken: []
      parameters:
        - in: query
          name: status
          schema: { $ref: '#/components/schemas/OrderStatus' }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  orders:
                    type: array
                    items: { $ref: '#/components/schemas/OrderWithItemsAdmin' }
              examples:
                exemplo:
                  value:
                    orders:
                      - id: ord-123
                        status: PREPARANDO
                        table_number: '5'
                        payment_method: PIX
                        total: 33.9
                        created_at: '2025-11-12T12:00:00Z'
                        user:
                          id: uuid-user
                          name: Maria Silva
                          email: maria@exemplo.com
                        items:
                          - id: oi-1
                            quantity: 2
                            unit_price: 6.5
                            total_price: 13.0
                            item:
                              id: it-coca
                              name: Coca-Cola Lata
                              price: 6.5
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
  /api/admin/orders/{id}/status:
    patch:
      tags: [Admin]
      summary: Atualiza status do pedido
      security:
        - bearerAuth: []
        - xAccessToken: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/SetOrderStatusRequest' }
            examples:
              exemplo:
                value:
                  status: PRONTO
      responses:
        '200': { description: OK }
        '400': { $ref: '#/components/responses/BadRequest' }
        '404': { $ref: '#/components/responses/NotFound' }
        '422': { $ref: '#/components/responses/UnprocessableEntity' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
  /api/admin/orders/{id}:
    delete:
      tags: [Admin]
      summary: Cancela pedido
      security:
        - bearerAuth: []
        - xAccessToken: []
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        '204': { description: Cancelado }
        '404': { $ref: '#/components/responses/NotFound' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
    xAccessToken:
      type: apiKey
      in: header
      name: x-access-token
      schemas:
    Error:
      type: object
      required: [ok, message]
      properties:
        ok: { type: boolean, example: false }
        message: { type: string, example: 'Ocorreu um erro.' }
        code: { type: string, nullable: true, example: 'UNAUTHORIZED' }
        details:
          type: object
          nullable: true
          additionalProperties: true
    ValidationError:
      type: object
      required: [ok, message, errors]
      properties:
        ok: { type: boolean, example: false }
        message: { type: string, example: 'Dados inválidos.' }
        errors:
          type: array
          items:
            type: object
            properties:
              field: { type: string, example: 'email' }
              message: { type: string, example: 'Email inválido.' }
        RegisterRequest:
          type: object
          required: [name, email, password]
          properties:
            name: { type: string }
            email: { type: string, format: email }
            password: { type: string, format: password }
            phone: { type: string }
        LoginRequest:
          type: object
          required: [email, password]
          properties:
            email: { type: string, format: email }
            password: { type: string }
        LoginResponse:
          type: object
          properties:
            token: { type: string }
            user: { $ref: '#/components/schemas/User' }
        User:
          type: object
          properties:
            id: { type: string }
            name: { type: string }
            email: { type: string }
            role: { type: string, enum: [CLIENTE, ADMIN, ROOT] }
            phone: { type: string, nullable: true }
            address: { type: string, nullable: true }
            zip_code: { type: string, nullable: true }
        UserUpdate:
          type: object
          description: Campos opcionais; ao alterar email, envie também password atual.
          properties:
            name: { type: string }
            email: { type: string, format: email }
            phone: { type: string }
            address: { type: string }
            zip_code: { type: string }
            password: { type: string, description: 'Senha atual para confirmar alterações.' }
        ChangePasswordRequest:
          type: object
          required: [currentPassword, newPassword, confirmPassword]
          properties:
            currentPassword: { type: string }
            newPassword: { type: string }
            confirmPassword: { type: string }
        RoleUpdate:
          type: object
          required: [role]
          properties:
            role: { type: string, enum: [CLIENTE, ADMIN, ROOT] }
        AdminResetPassword:
          type: object
          required: [password]
          properties:
            password: { type: string }
        Category:
          type: object
          properties:
            id: { type: string }
            name: { type: string }
        Item:
          type: object
          properties:
            id: { type: string }
            name: { type: string }
            price: { type: number, format: float }
            description: { type: string, nullable: true }
            image_url: { type: string, nullable: true }
            is_active: { type: boolean }
        CategoryWithItems:
          allOf:
            - $ref: '#/components/schemas/Category'
            - type: object
              properties:
                items:
                  type: array
                  items: { $ref: '#/components/schemas/Item' }
        CreateItemRequest:
          type: object
          required: [name, price, categoryId]
          properties:
            name: { type: string }
            price: { type: number, format: float, minimum: 0 }
            categoryId: { type: string }
            description: { type: string }
            image_url: { type: string }
        UpdateItemRequest:
          type: object
          properties:
            name: { type: string }
            price: { type: number, format: float, minimum: 0 }
            description: { type: string }
            image_url: { type: string }
            is_active: { type: boolean }
        PaymentMethod:
          type: string
          enum: [DINHEIRO, DEBITO, CREDITO, PIX]
        OrderStatus:
          type: string
          enum: [PENDENTE, PREPARANDO, PRONTO, ENTREGUE, CANCELADO]
        OrderItemInput:
          type: object
          required: [itemId, quantity]
          properties:
            itemId: { type: string }
            quantity: { type: integer, minimum: 1 }
        CreateOrderRequest:
          type: object
          required: [tableNumber, paymentMethod, items]
          properties:
            tableNumber: { type: string, nullable: true }
            paymentMethod: { $ref: '#/components/schemas/PaymentMethod' }
            items:
              type: array
              items: { $ref: '#/components/schemas/OrderItemInput' }
        OrderItem:
          type: object
          properties:
            id: { type: string }
            quantity: { type: integer }
            unit_price: { type: number, format: float }
            total_price: { type: number, format: float }
            item: { $ref: '#/components/schemas/Item' }
        Order:
          type: object
          properties:
            id: { type: string }
            user_id: { type: string }
            table_number: { type: string, nullable: true }
            status: { $ref: '#/components/schemas/OrderStatus' }
            payment_method: { $ref: '#/components/schemas/PaymentMethod' }
            subtotal: { type: number, format: float }
            tax: { type: number, format: float }
            total: { type: number, format: float }
            created_at: { type: string, format: date-time }
        OrderWithItems:
          allOf:
            - $ref: '#/components/schemas/Order'
            - type: object
              properties:
                items:
                  type: array
                  items: { $ref: '#/components/schemas/OrderItem' }
        OrderWithItemsAdmin:
          allOf:
            - $ref: '#/components/schemas/OrderWithItems'
            - type: object
              properties:
                user: { $ref: '#/components/schemas/User' }
        SetOrderStatusRequest:
          type: object
          required: [status]
          properties:
            status: { $ref: '#/components/schemas/OrderStatus' }
      responses:
        BadRequest:
          description: Requisição inválida
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
              examples:
                exemplo:
                  value: { ok: false, code: 'BAD_REQUEST', message: 'Requisição inválida.' }
        Unauthorized:
          description: Não autenticado
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
              examples:
                exemplo:
                  value: { ok: false, code: 'UNAUTHORIZED', message: 'Não autenticado.' }
        Forbidden:
          description: Sem permissão
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
              examples:
                exemplo:
                  value: { ok: false, code: 'FORBIDDEN', message: 'Sem permissão.' }
        ConflictEmail:
          description: Email já cadastrado
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
              examples:
                exemplo:
                  value: { ok: false, code: 'CONFLICT', message: 'Email já cadastrado.' }
        NotFound:
          description: Recurso não encontrado
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
              examples:
                exemplo:
                  value: { ok: false, code: 'NOT_FOUND', message: 'Recurso não encontrado.' }
        UnprocessableEntity:
          description: Erro de validação (campos inválidos)
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ValidationError' }
              examples:
                exemplo:
                  value:
                    ok: false
                    message: 'Dados inválidos.'
                    errors:
                      - field: 'email'
                        message: 'Email inválido.'
                      - field: 'password'
                        message: 'Senha deve ter pelo menos 8 caracteres.'